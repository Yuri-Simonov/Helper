<mat-accordion>
    <mat-expansion-panel
        (opened)="panelOpenState = true"
        (closed)="panelOpenState = false"
    >
        <mat-expansion-panel-header>
            <mat-panel-title>
                Как создать пользователький компонент формы (input, textarea и
                др)?
            </mat-panel-title>
        </mat-expansion-panel-header>
        <p>
            Компоненты, содержащие пользователькие поля формы (Custom Controls),
            создаются с помощью встроенной директивы
            <code>ControlValueAccessor</code>, которая отвечает за отслеживание
            значения поля формы в дочернем компоненте и передачу его обратно в
            родительскую форму.
        </p>
        <p>Для демонстрации необходимо 2 компонента: родитель и ребенок.</p>
        <p>Родительский компонент:</p>
        <pre><code><span class="keyword">@Component</span><span class="punctuation">({{'{'}}</span>
	<span class="key">selector</span>: <span class="string">'parent-component'</span>,
	<span class="key">template</span>: <span class="string">'{{'<'}}counter-control>{{'<'}}/counter-control>'</span>
<span class="punctuation">{{'}'}})</span>

<span class="export">export</span> <span class="keyword">class</span> <span class="class-name">ParentComponent</span> <span class="punctuation">{{'{}'}}</span></code></pre>
        <p>Дочерний компонент:</p>
        <pre><code><span class="keyword">@Component</span><span class="punctuation">({{'{'}}</span>
	<span class="key">selector</span>: <span class="string">'counter-component'</span>,
	<span class="key">template</span>: <span class="string">`
		{{'<'}}button (click)="down()">Down{{'<'}}/button>
			{{'{'}}{{'{'}}{{'counter}}'}}
		{{'<'}}button (click)="up()">Up{{'<'}}/button>
		`</span>
<span class="punctuation">{{'}'}})</span>

<span class="export">export</span> <span class="keyword">class</span> <span class="class-name">CounterControlComponent</span> <span class="punctuation">{{'{'}}</span>
	<span class="keyword">@Input</span><span class="punctuation">(</span><span class="string">'counter'</span><span class="punctuation">)</span> counterProps <span class="operator">=</span> <span class="number">0</span>;
 
	<span class="method">up()</span> <span class="punctuation">{{'{'}}</span>
		<span class="object">this</span>.counterProps<span class="operator">++</span>;
 	<span class="punctuation">{{'}'}}</span>
 
	<span class="method">down()</span> <span class="punctuation">{{'{'}}</span>
 		<span class="object">this</span>.counterProps<span class="operator">--</span>;
	<span class="punctuation">{{'}'}}</span>
<span class="punctuation">{{'}'}}</span></code></pre>
        <p>
            Суть примера будет следующая: у нас будет простой счетчик, где есть
            2 кнопки - для увеличения и уменьшения значения.
        </p>
        <p>
            В данный пример теперь необходимо внедрить
            <code>ControlValueAccessor</code> и методы, необходимые для его
            работы. Их всего 4:
        </p>
        <ul>
            <li>
                <span class="attention">writeValue</span> - устанавливает
                начальное значение в элемент формы;
            </li>
            <li>
                <span class="attention">registerOnChange</span> - сообщает
                родителю об изменении значения;
            </li>
            <li>
                <span class="attention">registerOnTouched</span> - сообщает
                родителю о том, что произошло взаимодействие пользователя с
                элементом формы;
            </li>
            <li>
                <span class="attention">setDisabledState</span> - управление
                видимостью элемента формы, т.е. сможем ли мы как-то изменять его
                или нет.
                <span class="attention">Является опциональным методом.</span>
            </li>
        </ul>
        <pre><code><span class="keyword">@Component</span><span class="punctuation">({{'{'}}</span>
	<span class="key">selector</span>: <span class="string">'counter-component'</span>,
	<span class="key">template</span>: <span class="string">`
		{{'<'}}button (click)="down()">Down{{'<'}}/button>
			{{'{'}}{{'{'}}{{'counter}}'}}
		{{'<'}}button (click)="up()">Up{{'<'}}/button>
		`</span>,
	<span class="key">providers</span>: <span class="punctuation">[{{'{'}}</span>
		<span class="key">provide</span>: NG_VALUE_ACCESSOR, <span class="comment">// Токен</span>
		<span class="key">useExisting</span>: <span class="method">forwardRef</span><span class="punctuation">(()</span> <span class="operator">=></span> <span class="class-name">CounterControlComponent</span><span class="punctuation">)</span>, <span class="comment">// Экземпляр используемого компонента</span>
		<span class="key">multi</span>: <span class="boolean">true</span> <span class="comment">// зависимостей с таким токеном может быть больше 1</span>
 	<span class="punctuation">{{'}'}}]</span>
<span class="punctuation">{{'}'}})</span>

<span class="comment">// Реализовываем интерфейс ControlValueAccessor</span>
<span class="export">export</span> <span class="keyword">class</span> <span class="class-name">CounterControlComponent</span> <span class="keyword">implements</span> <span class="interface-name">ControlValueAccessor</span> <span class="punctuation">{{'{'}}</span>
	<span class="keyword">@Input</span><span class="punctuation">(</span><span class="string">'counter'</span><span class="punctuation">)</span> counterProps <span class="operator">=</span> <span class="number">0</span>;
 
	<span class="method">onChange</span><span class="punctuation">(</span>_: <span class="type">any</span><span class="punctuation">)</span> <span class="punctuation">{{'{}'}}</span>
	<span class="method">onTouch</span><span class="punctuation">(</span>_: <span class="type">any</span><span class="punctuation">)</span> <span class="punctuation">{{'{}'}}</span>
	disabled: <span class="type">boolean</span>;

	<span class="method">up()</span> <span class="punctuation">{{'{'}}</span>
		<span class="object">this</span>.counterProps<span class="operator">++</span>;
		<span class="object">this</span>.<span class="method">onChange</span><span class="punctuation">(</span><span class="object">this</span>.counterProps<span class="punctuation">)</span>;
 	<span class="punctuation">{{'}'}}</span>
 
	<span class="method">down()</span> <span class="punctuation">{{'{'}}</span>
 		<span class="object">this</span>.counterProps<span class="operator">--</span>;
		<span class="object">this</span>.<span class="method">onChange</span><span class="punctuation">(</span><span class="object">this</span>.counterProps<span class="punctuation">)</span>;
	<span class="punctuation">{{'}'}}</span>

	<span class="method">writeValue</span><span class="punctuation">(</span>counter: <span class="type">number</span><span class="punctuation">)</span> <span class="punctuation">{{'{'}}</span>
		<span class="object">this</span>.counterProps <span class="operator">=</span> counter;
	<span class="punctuation">{{'}'}}</span>

	<span class="method">registerOnChange</span><span class="punctuation">(</span>onChange: <span class="type">any</span><span class="punctuation">)</span> <span class="punctuation">{{'{'}}</span>
		<span class="object">this</span>.<span class="method">onChange</span> <span class="operator">=</span> onChange;
	<span class="punctuation">{{'}'}}</span>

	<span class="method">registerOnTouched</span><span class="punctuation">(</span>onTouched: <span class="type">any</span><span class="punctuation">)</span> <span class="punctuation">{{'{'}}</span>
		<span class="object">this</span>.<span class="method">onTouched</span> <span class="operator">=</span> onTouched;
	<span class="punctuation">{{'}'}}</span>

	<span class="method">setDisabledState</span><span class="operator">?</span><span class="punctuation">(</span>disabled: <span class="type">boolean</span><span class="punctuation">)</span> <span class="punctuation">{{'{'}}</span>
		<span class="object">this</span>.disabled <span class="operator">=</span> disabled;
	<span class="punctuation">{{'}'}}</span>
<span class="punctuation">{{'}'}}</span></code></pre>
        <p>Теперь давайте разберемся в том, что написано выше.</p>
        <p>
            В самом начале мы сообщаем Angular, что реализовываем интерфейс
            <code>ControlValueAccessor</code>, и внедряем зависимость от него
            прямо в компонент в поле <code>providers</code>. Далее реализовываем
            все необходимые методы для данного интерфейса.
        </p>
        <p>
            И теперь осталось лишь немного добавить код родительскому
            компоненту, чтобы довести начатое до конца:
        </p>
        <pre><code><span class="keyword">@Component</span><span class="punctuation">({{'{'}}</span>
	<span class="key">selector</span>: <span class="string">'parent-component'</span>,
	<span class="key">template</span>: <span class="string">'
		{{'<'}}form [formGroup]="form">
   			{{'<'}}counter-control formControlName="counter">{{'<'}}/counter-control>
  		{{'<'}}/form>
		'</span>
<span class="punctuation">{{'}'}})</span>

<span class="export">export</span> <span class="keyword">class</span> <span class="class-name">ParentComponent</span> <span class="keyword">implements</span> <span class="interface-name">OnInit</span> <span class="punctuation">{{'{'}}</span>
	form: <span class="type">FormGroup</span>;

	<span class="keyword">constructor</span><span class="punctuation">(</span><span class="keyword">private</span> fb: <span class="type">FormBuilder</span><span class="punctuation">) {{'{}'}}</span>

	<span class="method">ngOnInit()</span> <span class="punctuation">{{'{'}}</span>
		<span class="object">this</span>.form <span class="operator">=</span> <span class="object">this</span>.fb.group<span class="punctuation">({{'{'}}</span> counter: <span class="number">5</span> <span class="punctuation">{{'}'}})</span>
	<span class="punctuation">{{'}'}}</span>
<span class="punctuation">{{'}'}}</span></code></pre>
        <p>
            Выше пример для реактивной формы. Для шаблонной формы родитель
            выглядел бы следующим образом:
        </p>
        <pre><code><span class="keyword">@Component</span><span class="punctuation">({{'{'}}</span>
	<span class="key">selector</span>: <span class="string">'parent-component'</span>,
	<span class="key">template</span>: <span class="string">'{{'<'}}counter-control [(ngModel)]="controlValue">{{'<'}}/counter-control>'</span>
<span class="punctuation">{{'}'}})</span>

<span class="export">export</span> <span class="keyword">class</span> <span class="class-name">ParentComponent</span> <span class="punctuation">{{'{'}}</span>
	controlValue <span class="operator">=</span> <span class="number">10</span>;
<span class="punctuation">{{'}'}}</span></code></pre>
    </mat-expansion-panel>
</mat-accordion>
